var isNode="undefined"==typeof window,_=isNode?require("lodash"):this._,pipeline={},pipeline={createApp:function(t){var e={stores:[],adapters:[]},n=function(t,e){for(var n={},i=0;i<t.length;i++){var r=t[i];n[r]=e(r)}return n},i=function(t){var e=_.filter(t,function(t){return _.isEmpty(t.after)});if(_.isEmpty(e))return!1;for(var n=_.pluck(e,"storeKey"),i=_.difference(t,e);!_.isEmpty(i);){var r=!0;if(i.forEach(function(t){_.every(t.after,function(t){return n.indexOf(t)>=0})&&(r=!1,e.push(t),n.push(t.storeKey))}),r)return!1;i=_.difference(i,e)}return e},r=!1,a=!1,o=[],s={actionCallbacks:{},storeCallbacks:{},changedStores:{},onAction:function(t,e,n,r){var a=this;null==this.actionCallbacks[e]&&(this.actionCallbacks[e]=[]);var o=!_.every(n,function(t){return _.find(a.actionCallbacks[e],function(e){return t===e.storeKey})});if(this.actionCallbacks[e].push({storeKey:t,after:n||[],callback:r}),!o){var s=i(this.actionCallbacks[e]);if(s===!1)throw this.actionCallbacks[e].pop(),new Error('store "'+t+'"\'s action "'+e+'" creates a circular dependency');this.actionCallbacks[e]=s}},registerStoreCallback:function(t,e,n){null==this.storeCallbacks[t]&&(this.storeCallbacks[t]=[]),this.storeCallbacks[t].push({adapterKey:e,callback:n})},unregisterStoreCallback:function(t,e){_.remove(this.storeCallbacks[t],e)},storeHasChanged:function(t){this.changedStores[t]=!0},dispatchAction:function(t,e){null!=this.actionCallbacks[t]&&_.forEach(this.actionCallbacks[t],function(t){t.callback(e)});for(var n in this.changedStores)null!=this.storeCallbacks[n]&&_.forEach(this.storeCallbacks[n],function(t){t.callback()})},dispatchActions:function(){r=!1;for(var t=0;t<o.length;t++){var e=o[t].actionKey,n=o[t].payload;this.dispatchAction(e,n)}o=[],r=!0},enqueueAction:function(t,e){o.push({actionKey:t,payload:e}),r&&this.dispatchActions()},runStoreCallbacks:function(){for(var t in this.changedStores)if(null!=this.storeCallbacks[t])for(var e in this.storeCallbacks[t])e.callback()}};return{actions:{},stores:{},createActions:function(t){var e=this;_.forEach(t,function(t,n){e.createAction(n,t)})},createAction:function(t,e){if(a)throw new Error('cannot create new action "'+t+'". App has already started.');this.actions[t]=function(){var n=e.apply(null,arguments);s.enqueueAction(t,"object"==typeof n?n:{})}},createStore:function(t,i){if(a)throw new Error('cannot create new store "'+t+'". App has already started.');var r,o={},c=function(t,e){if("object"==typeof t)for(var n in t)o[n]=t[n];else"string"==typeof t&&(o[t]=e)};if(r="string"==typeof i.after?[i.after]:Array.isArray(i.after)?i.after:[],r.indexOf(t)>=0)throw new Error('store "'+t+'" waits for itself');var l=_.intersection(_.keys(i),["stores","key","get","update"]);_.isEmpty(l)||_.each(l,function(e){throw new Error('In "'+t+'" Store: "'+e+'" is a reserved key and cannot be used.')});var f=_.omit(i,["initialize","api","actions"]);_.each(f,function(t,e){_.isFunction(t)&&(f[e]=t.bind(f))});var u=function(){s.storeHasChanged(t)};_.extend(f,{key:t,api:{},get:function(t){return _.clone(null!=t?o[t]:o)},update:function(t,e){c(t,e),u()}});var h=this.stores,p={get:function(t){return _.cloneDeep(null!=t?o[t]:o)}};if(_.forEach(i.api,function(t,e){if("get"!==e){var n=t.bind(f);f.api[e]=n,p[e]=n}}),_.forEach(i.actions,function(e,i){var a,o;if("function"==typeof e)a=r,o=e;else{if(t===e.after||e.after.indexOf(t)>=0)throw new Error('on action "'+i+'", store "'+t+'" waits for itself to update');a=_.unique(r.concat(e.after)),o=e.action}var c=function(t){f.stores=n(a,function(t){return h[t]}),o.call(f,t)};s.onAction(t,i,a,c)}),_.isFunction(i.initialize)){var d=_.omit(f,["actions","update"]);d.update=c,e.stores.push(i.initialize.bind(d))}return this.stores[t]=p,p},createAdapter:function(t,n){var i={key:t,stores:this.stores,actions:this.actions};_.forEach(_.omit(n,["stores","initialize"]),function(t,e){_.isFunction(t)&&(i[e]=t.bind(i))}),_.forEach(n.stores,function(e,n){s.registerStoreCallback(n,t,e.bind(i))}),_.isFunction(n.initialize)&&e.adapters.push(n.initialize.bind(_.omit(i,"actions")))},reactMixin:function(t){_.isString(t)&&(t=[t]),storesObj={};for(var e=0;e<t.length;e++){var n=t[e];storesObj[n]=this.stores[n]}return{stores:storesObj,actions:this.actions,componentDidMount:function(){for(var e=0;e<t.length;e++){var n=t[e];StoreKey=n.charAt(0).toUpperCase()+n.slice(1),cb=this["on"+StoreKey+"Change"],_.isFunction(cb)&&s.registerStoreCallback(n,"react-view",cb)}},componentWillUnmount:function(){for(var e=0;e<t.length;e++){var n=t[e];StoreKey=n.charAt(0).toUpperCase()+n.slice(1),cb=this["on"+StoreKey+"Change"],_.isFunction(cb)&&s.unregisterStoreCallback(n,cb)}}}},start:function(){if(!a&&(_.forEach(e.stores,function(t){t()}),delete e.stores,_.forEach(e.adapters,function(t){t()}),delete e.adapters,s.runStoreCallbacks(),r=!0,a=!0,null!=t&&_.isFunction(t.initialize))){var n={stores:this.stores,actions:this.actions};t.initialize.call(n)}}}}};isNode?module.exports=pipeline:window.pipeline=pipeline;